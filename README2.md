# LensorOS
A 64-bit all-inclusive operating system, from bootloader to userspace.

NOTE: This is meant as a replacement for the original README, it's a WIP right now.

---

## Table of Contents

- [Running LensorOS](#run)
- [Building LensorOS](#build)

---

## Running LensorOS <a name="run"></a>

1. [As a tourist](#tourists-go-here)
2. [As a developer](#developers-go-here)

Free, compatible virtual machines:
- [Quick Emulator (QEMU)](https://www.qemu.org/download/)
- [VirtualBox (VBOX)](https://www.virtualbox.org/wiki/Downloads)

---

### I just want to open LensorOS! <a name="tourists-go-here"></a>
If you are just interested in poking around LensorOS, and not editing code,
  I recommend a pre-built release from the 
  [releases page](https://github.com/LensPlaysGames/LensorOS/releases). 
  It will include all the necessary resources
  and instructions on how to run LensorOS.
  Keep in mind that this will be missing a lot of
  features to ensure maximum compatibility across systems.
  By building from source, you are able to build for
  your exact system and get every possible feature enabled.

---

### Launching LensorOS using the Build System <a name="developers-go-here"></a>
NOTE: There is no automation for VBOX, at least for now (I suck at using VBoxManage).
  There are, however, instructions on how to setup a virtual machine in VBOX.

When the CMake build system is generated, it looks for QEMU on your system;
  if it finds it, it will add the following targets to the project.
  Invoke them to launch QEMU from the corresponding LensorOS boot media.

The targets:
- `runimg_qemu` -- LensorOS.img
- `runhda_qemu` -- LensorOS.bin
- `runiso_qemu` -- LensorOS.iso

Assuming the CMake build system was generated in the `/kernel/bld/` subdirectory, invoke like:
```sh
cmake --build kernel/bld --target <name of target>
```

---

## Building LensorOS  <a name="build"></a>
As an operating system is quite a complicated piece of software,
  there are multiple steps to the build process, outlined here.

1. [Bootloader](#bootloader)
2. [LensorOS Toolchain + Kernel](#toolchain-kernel)
3. [Boot Media Generation](#boot-media-generation)

All groups of shell commands given are expected to start with
  the root of the repository as the working directory.

---

### Bootloader <a name="bootloader"></a>

NOTE: This section **is going to change**, and any information here may become incorrect or out of date at any moment. This is due to being in the middle of migrating bootloaders to the self-created RADII bootloader.

The bootloader is an EFI application; specifically an OS loader written
  for the [UEFI spec. (currently V2.9)](https://uefi.org/specifications/).
  That specification outlines the use of PE32+ executables with a specific subsystem.
  As you may know, the PE32+ format is also used by Windows as it's executable format.
  This means that a compiler that generates Windows executables will generate the
  proper format of executable for an EFI application, given the subsystem modification. 
  However, twenty or so years ago, GNU decided to write custom relocation linker scripts 
  that create PE32+ executables from ELF executables. This means that a compiler that generates ELF executables is used, then that executable
  is transformed into a PE32+ executable with the proper subsystem for an EFI application.
  Luckily, all of this is handled by a Makefile.
  
Build dependencies for the bootloader:
```sh
cd gnu-efi
make
```
That only ever has to be done once, to generate `libgnuefi.a`.

From here, the bootloader executable can be built using the `bootloader` make target:
```sh
cd gnu-efi
make bootloader
```

---

### Toolchain + Kernel <a name="toolchain-kernel"></a>

[See the toolchain README](toolchain/README.md)

Once the toolchain is built and usable, continue on here.

I recommend taking a look at `kernel/config.cmake` and seeing what
  there is to fiddle with, but going with the defaults is just as well.

First, generate a build system using CMake.
  If you choose a different build system, keep in mind not all
  build systems honour our request to use a custom toolchain.
  I recommend Ninja, as it can speed up build times.
  Another tip to speed up build times; install `ccache`.
  The CMake scripts in this project detect and use it automatically.
```sh
cmake -G "Unix Makefiles" -S kernel -B kernel/bld
```

To generate the kernel executable, invoke the build system generated by CMake:
```sh
cmake --build kernel/bld
```

When generating a build system for the LensorOS kernel using CMake,
  it also checks for programs needed to build and run LensorOS;
  if the necessary programs are found, build targets are added
  that utilize these programs automatically.

To see a list of all available targets on
  most build systems, use the following command:
```sh
cmake --build kernel/bld --target help
```

---

### Boot Media Generation <a name="boot-media-generation"></a>
As stated above, the CMake will create targets if the
  proper dependencies are detected on the system. Here
  is a list of the current build targets relating to boot 
  media generation, as well as their dependencies listed 
  underneath each one.

- `image_raw` -- Combine built executables and resources to generate bootable media.
  - dd
    - Native Unix command
    - On Windows, use one of the following options:
      - [use MinGW installer to get MSYS coreutils ext package](https://osdn.net/projects/mingw/)
      - [use Cygwin](https://www.cygwin.com/)
  - GNU mtools
    - [Home Page](https://www.gnu.org/software/mtools/)
    - Debian distros: `sudo apt install mtools`
    - [Pre-built Binaries for Windows](https://github.com/LensPlaysGames/mtools/releases)
- `image_gpt` -- Create GPT-partitioned, bootable hard drive image from bootable media.
  - `image_raw`
  - mkgpt
    - [Repository](https://github.com/jncronin/mkgpt)
    - On Unix, use the automatic build + install script in the `scripts` subdirectory.
- `image_iso` -- Create ISO-9660 "El-Torito" bootable CD-ROM image from bootable media.
  - `image_raw`
  - GNU xorriso
    - [Home Page](https://www.gnu.org/software/xorriso/)
    - Debian distros: `sudo apt install xorriso`
    - [Pre-built Binaries for Windows](https://github.com/PeyTy/xorriso-exe-for-windows)

As you can see, these targets could be chained together to
  build LensorOS, generate boot media, and then, using the
  `run` targets outlined near the top, launch into LensorOS,
  all in just a few commands.

```bash
cmake --build kernel/bld \
  && cmake --build kernel/bld -t image_raw \
  && cmake --build kernel/bld -t runimg_qemu
```
